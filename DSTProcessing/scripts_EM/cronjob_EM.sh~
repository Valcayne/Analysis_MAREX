#!/bin/bash
#
# Author: Vasilis.Vlachoudis@cern.ch
# Date:   1 July 2015
# Modified: Michael.Bacak@cern.ch
# Date:   2 October 2017
#
DIR=$1
PSA=$2
OUT=$3
AUTO=$4

#MAXJOBS=2
MAXJOBS=800


if [ .$DIR = . -o .$PSA = . ]; then
	echo "syntax: cronjob.sh <running-directory> <UserInput.h> [auto]"
	exit
fi

cd ${DIR}
if [ .${AUTO} = .auto ]; then
	if [ -f .lock ]; then
#	  LockExistsSince=$(stat -c %Y .lock | echo `expr $(date +%s) - $(cat)`)
#	  if [[ "$LockExistsSince" -gt 3600 ]]; then
#	    rm -rf .lock
#	  else
#  		exit
#		fi
    exit
	fi
	touch .lock
fi



path=`dirname $0`
BINDIR=`readlink -m $path`
#source ${BINDIR}/setup.sh
#BINDIR=/afs/cern.ch/user/e/emendoza/Test2021/EAR2/DSTProcessing/myscripts/


date

# create a snapshot of the jobs running in HTCondor.
# Used later to check if a FileList is already submitted or not.
HTCondorOut=$DIR/HTCondor.out
condor_q -wide &> $HTCondorOut

# check if HTCondor is available
HTCondorAvailable=`grep -c Failed $HTCondorOut`
#echo HTCondorAvailable $HTCondorAvailable

# check if EOS is available
EOSAvailable=`ls $EOSPATH 2>&1 >/dev/null | grep -c cannot` # if eos is unreachable 'ls' will give an error (stderr) saying "... cannont access..." grep for cannot and count
#echo EOSAvailable $EOSAvailable


# choose the EOS directory respectively
#EOSPATH=/eos/experiment/ntof/processing/Users
EOSPATH=${OUT}
if [ "$USER" == "ntofpro" ]; then
  EOSPATH=/eos/experiment/ntof/processing/official
fi

# Loop over all directories with only a run number and sort them numerically
for dir in `/bin/ls | grep "^[0-9]*\$" | sort -n`; do
  if [[ "$EOSAvailable" == "0" ]] && [[ "$HTCondorAvailable" == "0" ]]; then
    # create directory for root files in EOS or if it exists in completed then move it
    # if it exists in both do nothing
	  echo "==== ${dir} ===="
    if [ -d $EOSPATH/completed/${dir} ]; then
      if [ -d $EOSPATH/${dir} ]; then
        echo "ERROR: Two EOS directories " $dir " exist in processing and completed "
      else
        echo "Moving EOS directory " $EOSPATH/$dir " from completed"
        rm -rf $EOSPATH/completed/${dir}/completed.done
        mv $EOSPATH/completed/${dir} $EOSPATH/.
      fi
    else
      if [ -d $EOSPATH/${dir} ]; then
        echo "EOS directory exists: " $EOSPATH/$dir
      else
        echo "Creating EOS directory " $EOSPATH/$dir
        mkdir -p $EOSPATH/${dir}
      fi
    fi
    
    # call the submission script
    ${BINDIR}/analyze_EM.sh ${dir} ${PSA} ${OUT} ${HTCondorOut}

  
	  rc=$? #RunCompleted ? is output from analyze.sh; if 0 the run is finished
	  if [ $rc -eq 0 ]; then # Run finished
	    echo Run ${dir} finished, moving directory to completed
      mv $EOSPATH/${dir} $EOSPATH/completed/.
		  mv ${dir} completed/.
	  fi
	else
    echo
	  echo ERROR EOSAvailable-$EOSAvailable- and/or HTCondorAvailable-$HTCondorAvailable no available.
	  echo
  fi

  # check the number of jobs submitted to HTCondor; if bigger than MAXJOBS exit the loop
  njobs=`condor_q | wc -l`
  njobs=$((njobs-9))
  if [ $njobs -ge $MAXJOBS ]; then
	  break
  fi

done


echo
echo "$njobs Jobs running"
if [ .${AUTO} = .auto ]; then
	rm -f .lock
fi


